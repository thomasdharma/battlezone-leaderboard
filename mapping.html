<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>Mapping Zone Kawasan</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    /* safe-area support */
    :root { --safe-top: env(safe-area-inset-top); }

    html, body {
      height: 100%; margin: 0; padding: 0;
      font-family: 'Orbitron', sans-serif;
      background: #0d0d0d url('assets/neon-bg.png') center/cover no-repeat fixed;
      overflow: hidden;
    }
    body { padding-top: calc(var(--safe-top) + 20px); }

    /* Info & Control Card */
    .info-panel {
      position: absolute;
      top: calc(var(--safe-top) + 10px);
      left: 50%; transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.6);
      border: 2px solid #0ff;
      border-radius: 12px;
      backdrop-filter: blur(8px);
      width: calc(100% - 40px);
      max-width: 360px;
      color: #0ff;
      box-shadow: 0 0 20px rgba(0, 255, 255, 0.5);
      overflow: hidden;
      z-index: 2;
      transition: height 0.3s ease;
    }
    .info-panel summary {
      list-style: none;
      padding: 12px 16px;
      font-size: 1.1em;
      font-weight: bold;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .info-panel summary::marker { content: none; }
    .info-panel summary:hover {
      background: rgba(0, 255, 255, 0.2);
    }
    .info-panel[open] {
      height: auto;
    }
    .info-panel:not([open]) {
      height: 52px;
    }
    .info-content {
      padding: 0 16px 16px;
      text-align: center;
    }

    .info-content h1 {
      margin: 8px 0 4px;
      font-size: 1.4em;
      text-shadow: 0 0 8px #0ff;
    }
    .info-content p.subtitle {
      margin: 0 0 8px;
      font-size: 0.9em;
      color: #8ff;
    }
    .summary-text {
      font-size: 0.85em;
      margin-bottom: 8px;
    }

    .controls {
      display: flex;
      justify-content: center;
      gap: 8px;
    }
    .controls button {
      flex: 1;
      background: linear-gradient(90deg, #0ff, #00cfcf);
      color: #000;
      font-weight: bold;
      border: none;
      padding: 8px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,255,255,0.4);
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
      font-size: 0.9em;
    }
    .controls button:hover {
      transform: scale(1.03);
      box-shadow: 0 4px 12px rgba(0,255,255,0.6);
    }

    /* Map container */
    #map {
      position: absolute;
      top: 0; left: 0; right: 0; bottom: 0;
      margin: 0;
      z-index: 1;
      touch-action: pan-x pan-y;
    }
    #map.animate { transform: scale(1.02); }

    /* Floating legend inside map */
    .map-legend {
      position: absolute;
      bottom: 16px; right: 16px;
      background: rgba(0,0,0,0.5);
      padding: 6px 10px;
      border-radius: 8px;
      color: #fff;
      font-size: 12px;
      z-index: 2;
      box-shadow: 0 0 10px rgba(0,0,0,0.7);
    }
    .map-legend div {
      display: flex; align-items: center; margin-bottom:4px;
    }
    .map-legend .legend-color {
      width: 10px; height: 10px; border-radius:50%; margin-right:6px;
    }
  </style>
</head>
<body>
  <div class="background"></div>

  <details open class="info-panel">
    <summary>‚ÑπÔ∏è Info & Kontrol <span>&#x25BC;</span></summary>
    <div class="info-content">
      <h1>üåê Mapping Zone Kawasan</h1>
      <p class="subtitle">Bank Mandiri Lapangan Merdeka</p>
      <p class="summary-text" id="summary-text">Loading data akuisisi...</p>
      <div class="controls">
        <button id="toggle-style">üåì Ganti Tampilan</button>
      </div>
    </div>
  </details>

  <div id="map">
    <div class="map-legend">
      <div><span class="legend-color" style="background:#0066cc"></span>Tim Alpha</div>
      <div><span class="legend-color" style="background:#cc0000"></span>Tim Bravo</div>
      <div><span class="legend-color" style="background:#00cc44"></span>Tim Charlie</div>
    </div>
  </div>

  <script>
    const teamColors = { 'Tim Alpha': '#0066cc','Tim Bravo': '#cc0000','Tim Charlie': '#00cc44' };
    const teamGradients = {
      'Tim Alpha': ['rgba(0,0,0,0)','rgba(0,102,204,0.4)','rgba(0,102,204,1)'],
      'Tim Bravo': ['rgba(0,0,0,0)','rgba(204,0,0,0.4)','rgba(204,0,0,1)'],
      'Tim Charlie':['rgba(0,0,0,0)','rgba(0,204,68,0.4)','rgba(0,204,68,1)']
    };
    const darkMapStyle = [ /* ... */ ];

    let map;
    function initMap() {
      const center = { lat:3.566559, lng:98.694630 };
      map = new google.maps.Map(document.getElementById('map'),{
        center, zoom:13,
        gestureHandling:'greedy',disableDoubleClickZoom:true,
        zoomControl:true,streetViewControl:false
      });

      // Custom My Location control...
      const locDiv=document.createElement('div');
      const locBtn=document.createElement('button');
      locBtn.textContent='üìç';locBtn.title='Tampilkan Lokasiku';
      Object.assign(locBtn.style,{background:'#fff',border:'none',outline:'none',width:'36px',height:'36px',borderRadius:'4px',boxShadow:'0 1px 4px rgba(0,0,0,0.3)',cursor:'pointer',fontSize:'20px',textAlign:'center',lineHeight:'36px'});
      locDiv.style.margin='10px';locDiv.appendChild(locBtn);
      map.controls[google.maps.ControlPosition.TOP_RIGHT].push(locDiv);
      locBtn.addEventListener('click',()=>{
        navigator.geolocation?.getCurrentPosition(pos=>{
          const userPos={lat:pos.coords.latitude,lng:pos.coords.longitude};
          map.setCenter(userPos);
          new google.maps.Marker({position:userPos,map,animation:google.maps.Animation.DROP,icon:{url:'http://maps.google.com/mapfiles/ms/icons/yellow-dot.png'},clickable:false,zIndex:1});
        },()=>alert('Gagal mendeteksi lokasi.'));
      });

      new google.maps.KmlLayer({url:'https://www.google.com/maps/d/kml?forcekml=1&mid=11uDxJ_HJDwN9UbU9ihAhrloBmR--18o',preserveViewport:true,clickable:false,map});
      loadMerchantData();setInterval(loadMerchantData,180000);
    }

    function loadMerchantData(){
      fetch('https://opensheet.elk.sh/1Cxpf0WMF0IPlNbhaQHjh6cetou73JnJWxN1etdNkIII/Akuisisi%20Merchant')
      .then(r=>r.json()).then(data=>{
        const perTeamHeat={'Tim Alpha':[],'Tim Bravo':[],'Tim Charlie':[]};
        const markerCount={'Tim Alpha':0,'Tim Bravo':0,'Tim Charlie':0};
        data.forEach(item=>{
          const lat=parseFloat(item.Lat),lng=parseFloat(item.Lng),team=item['Nama Tim']||'‚Äì';
          if(isNaN(lat)||isNaN(lng)||!team)return;
          const pos=new google.maps.LatLng(lat,lng);
          perTeamHeat[team].push(pos);markerCount[team]++;
          const marker=new google.maps.Marker({position:pos,map,zIndex:2,icon:{path:google.maps.SymbolPath.CIRCLE,scale:1,fillOpacity:0,strokeWeight:0},label:{text:'üìå',color:teamColors[team],fontSize:'24px'}});
          const infoHtml=`<div style="background:#fff;color:#000;padding:10px 14px;border-radius:8px;font-family:'Orbitron',sans-serif;line-height:1.4;min-width:200px;">
            <strong>Nama Toko:</strong> ${item['Nama Toko']}<br>
            <strong>PIC:</strong> ${item.PIC||'-'}<br>
            <strong>Nama Tim:</strong> ${team}<br>
            <strong>Produk:</strong> ${item.Produk||'-'}<br>
            <strong>Alamat:</strong> ${item.Alamat||'-'}<br>
            <strong>Lat:</strong> ${lat}<br>
            <strong>Lng:</strong> ${lng}<br>
            <a href="https://www.google.com/maps?q=${lat},${lng}" target="_blank" style="margin-top:8px;display:inline-block;background:#0ff;color:#000;padding:4px 8px;border-radius:6px;text-decoration:none;font-weight:bold;">üìç Buka di Google Maps</a>
          </div>`;
          const iw=new google.maps.InfoWindow({content:infoHtml});marker.addListener('click',()=>iw.open(map,marker));
        });
        Object.entries(perTeamHeat).forEach(([team,pts])=>{if(!pts.length)return;new google.maps.visualization.HeatmapLayer({data:pts,radius:50,gradient:teamGradients[team]}).setMap(map);});
        document.getElementById('summary-text').textContent=Object.entries(markerCount).map(([t,c])=>`${t}: ${c} titik`).join(' ‚Ä¢ ');
      }).catch(e=>{console.error(e);document.getElementById('summary-text').textContent='Gagal memuat data.';});
    }

    document.addEventListener('DOMContentLoaded',()=>{
      document.getElementById('toggle-style').addEventListener('click',()=>{
        const styles=map.get('styles');map.setOptions({styles:styles?null:darkMapStyle});
        document.getElementById('map').classList.add('animate');
        setTimeout(()=>document.getElementById('map').classList.remove('animate'),500);
      });
    });
  </script>
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAwuSerwi_mY5J89CihWaUZ6Itl_0ywIto&libraries=visualization&callback=initMap" async defer></script>
</body>
</html>
